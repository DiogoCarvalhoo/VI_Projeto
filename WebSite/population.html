<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <!-- MY CSS -->
    <link href="CSS/menu.css" rel="stylesheet" />
    <link href="CSS/home.css" rel="stylesheet" />
    <link href="CSS/style.css" rel="stylesheet" />


    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>


    <title>InfoPortugal</title>
    <style>
      body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  padding-bottom: 20px;
}

.topnav {
  overflow: hidden;
  background-color: #EBC8B2;
}

.topnav a {
  float: left;
  color:white; 
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
  font-size: 17px;
}

.topnav a:hover {
  background-color:#EBC8B2;
  color: black;
}

.topnav a.active {
  background-color: #EBC8B2;
  color: black;
}


div.layout {
  text-align: center;
}

div#container1 {
  margin: auto;
}

div#container2 {
  margin: auto;
}

div#container3 {
  margin: auto;
}

svg {
  width: 100%;
  height: 100%;
}

.bar {
  fill: lightskyblue;
}

text {
  font-size: 10px;
  width: 10px;
  fill: white;
}

line {
  stroke: gray;
}

line#limit {
  stroke: black;
  stroke-width: 3;
  stroke-dasharray: 3 6;
}

.grid path {
  stroke-width: 0;
}

.grid .tick line {
  stroke: #9FAAAE;
  stroke-opacity: 1;
}

text.divergence {
  font-size: 10px;
  fill: green;
}

text.value {
  font-size: 10px;
}

text.title {
  font-size: 22px;
  font-weight: 600;
  margin-top: 200px;
}

text.label {
  font-size: 14px;
  font-weight: 400;
}

text.source {
  font-size: 10px;
}
    </style>
  </head>
  <body onload="main('population')">

    <div class="main" id="body">

      <!-- 
          SideMenu Generated
      -->
      
      <main>
        <div class="container" style="text-align: center;">
          <div class="row">
            <div class="col-md-7">

                <div class="row">
                  <div class='layout' style="text-align: center;">
                    <div id='container1' style="height: 400px; margin: auto; ">
                        <svg id="svg1" style="width: 100%; height: 100%;"></svg>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class='layout' style="text-align: center;">
                    <div id='container2' style="height: 400px; margin: auto; ">
                        <svg id="svg2" style="width: 100%; height: 100%;"></svg>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class='layout' style="text-align: center;">
                    <div id='container3' style="height: 400px; margin: auto; ">
                        <svg id="svg3" style="width: 100%; height: 100%;"></svg>
                    </div>
                  </div>
                </div>
            </div>
            <div class="col-md-5">
              AQUELA
            </div>
          </div>
        </div>


      </main>


      

    </div>

    <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"
    ></script>

    <!-- MY JS -->
    <script src="JS/index.js"></script>
    <script src="JS/menu.js"></script>
    <script src="JS/home.js"></script>

    <script type="text/javascript">

      /* Histograma */
      // População por faixa etária [total  0-04	05-09 10-14	15-19	20-24	25-29	30-34	35-39	40-44	45-49	50-54	55-59	60-64	65-69	70-74	75 ou mais]
      let dataset1 = {1960: [ 8889392, 901410, 851145, 839400, 747225, 705204, 673194, 637452, 591184, 499411, 510724, 481429, 409026, 334019, 264150, 206298, 238121],
                       1970: [ 8611125,	789355, 849785,	812710, 730900, 628040,	518735, 533985, 555740, 551385, 513230, 444600, 439750, 410150, 326250, 233720, 272790],
                       1981: [ 8611125, 789355, 849785, 812710, 730900, 628040, 518735, 533985, 555740, 551385, 513230, 444600, 439750, 410150, 326250, 233720,	272790],
                       1991: [ 9867147, 544309, 646161, 781933, 845588, 765248, 726628, 694606, 661076, 634519, 569623, 559346, 562041, 533325, 470049, 344747, 527948],
                       2001: [ 10356117, 539491, 537521, 579590, 688686, 790901, 814661, 761457, 770781, 728518, 686134, 642516, 571452, 550916, 538165, 453962, 701366],
                       2011: [ 10562178, 482647, 525087, 564595, 565250, 582065, 656076, 773567, 824683, 773098, 770294, 722360, 677651, 634741, 551701, 496438, 961925]}
                    


        // Populaçao por genero [masculino, feminino]
        let dataset3 = {
            1960: [4254416, 4634976],
            1970: [4109360, 4553892],
            1981: [4737715, 5095299],
            1991: [4756775, 5110372],
            2001: [5000141, 5355976],
            2011: [5046600, 5515578],
            2021: [4917794, 5430098]
        }
        


        //Dimensions
        margin = 80;
        width = 700 - 2 * margin;
        height = 400 - 2 * margin;

        dataset = [{type:"0-04", value:901410}, 
                       {type:"05-09", value:851145}, 
                       {type:"10-14", value:839400}, 
                       {type:"15-19", value:747225}, 
                       {type:"20-24", value:705204}, 
                       {type:"25-29", value:673194}, 
                       {type:"30-34", value:637452}, 
                       {type:"35-39", value:591184}, 
                       {type:"40-44", value:499411}, 
                       {type:"45-49", value:510724}, 
                       {type:"50-54", value:481429}, 
                       {type:"55-59", value:409026}, 
                       {type:"60-64", value:334019}, 
                       {type:"65-69", value:264150}, 
                       {type:"70-74", value:206298}, 
                       {type:"+75", value:238121}]



        faixa_etaria_graph(dataset, margin, width, height)




        dataset =  [
            {year: "1970", value: 67.1},
            {year: "1971", value: 66.8},
            {year: "1972", value: 68.5},
            {year: "1973", value: 67.6},
            {year: "1974", value: 68.2},
            {year: "1975", value: 68.4},
            {year: "1976", value: 69.0},
            {year: "1977", value: 70.1},
            {year: "1978", value: 70.5},
            {year: "1979", value: 71.0},
            {year: "1980", value: 71.1},
            {year: "1981", value: 71.7},
            {year: "1982", value: 72.5},
            {year: "1983", value: 72.4},
            {year: "1984", value: 72.6},
            {year: "1985", value: 72.9},
            {year: "1986", value: 73.4},
            {year: "1987", value: 73.8},
            {year: "1988", value: 73.8},
            {year: "1989", value: 74.4},
            {year: "1990", value: 74.1},
            {year: "1991", value: 74.1},
            {year: "1992", value: 74.4},
            {year: "1993", value: 74.6},
            {year: "1994", value: 75.0},
            {year: "1995", value: 75.4},
            {year: "1996", value: 75.3},
            {year: "1997", value: 75.5},
            {year: "1998", value: 75.8},
            {year: "1999", value: 76.0},
            {year: "2000", value: 76.4},
            {year: "2001", value: 76.7},
            {year: "2002", value: 77.0},
            {year: "2003", value: 77.4},
            {year: "2004", value: 77.7},
            {year: "2005", value: 78.2},
            {year: "2006", value: 78.5},
            {year: "2007", value: 78.7},
            {year: "2008", value: 78.9},
            {year: "2009", value: 79.3},
            {year: "2010", value: 79.6},
            {year: "2011", value: 79.8},
            {year: "2012", value: 80.0},
            {year: "2013", value: 80.2},
            {year: "2014", value: 80.4},
            {year: "2015", value: 80.6},
            {year: "2016", value: 80.8},
            {year: "2017", value: 80.8},
            {year: "2018", value: 80.9},
            {year: "2019", value: 81.1}
        ]

        esperanca_media_vida_graph(dataset, margin, width, height)
        


        
        dataset = [
          {'year': 1960, 'results': {'M': {'value': 4254416, 'percentage': 47.8}, 'F': {'value': 4634976, 'percentage': 52.2} }},
          {'year': 1970, 'results': {'M': {'value': 4109360, 'percentage': 47.4}, 'F': {'value': 4553892, 'percentage': 52.6} }},
          {'year': 1981, 'results': {'M': {'value': 4737715, 'percentage': 48.2}, 'F': {'value': 5095299, 'percentage': 51.8} }},
          {'year': 1991, 'results': {'M': {'value': 4756775, 'percentage': 48.2}, 'F': {'value': 5110372, 'percentage': 51.8} }},
          {'year': 2001, 'results': {'M': {'value': 5000141, 'percentage': 48.3}, 'F': {'value': 5355976, 'percentage': 51.7} }},
          {'year': 2011, 'results': {'M': {'value': 5046600, 'percentage': 47.8}, 'F': {'value': 5515578, 'percentage': 52.2} }},
          {'year': 2021, 'results': {'M': {'value': 4917794, 'percentage': 47.5}, 'F': {'value': 5430098, 'percentage': 52.5} }}
        ]

        //genero_graph(dataset, margin, width, height)
        
        // create a tooltip
        var Tooltip = d3.select("#container3")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px")

        const radius = Math.min(width, height) / 2 ;


        svg3 = d3.select("#svg3")
                  .attr("width", width + margin + margin)
                  .attr("height", height + margin + margin);
        const chart = svg3.append('g').attr("transform", `translate(${margin}, ${margin})`);

        const color = d3.scaleOrdinal()
            .domain(["M", "F"])
            .range(d3.schemeDark2);

        var arc = d3.arc()
          .outerRadius(radius)
          .innerRadius(0);

        var pie = d3.pie()
            .value(function(d) { return d[1] == undefined ? undefined: d[1].value; })
            .sort(function(a, b) { return d3.ascending(a.key, b.key);} ) // This make sure that group order remains the same in the pie chart

        const data_ready = pie(Object.entries(dataset[0].results))


        var g = svg3.selectAll(".arc")
          .data(data_ready)
          .enter().append("g");    

        g.append("path")
          .attr("d", arc)
          .attr("transform", "translate(" + (width/2+margin) + "," + (height/2+margin) + ")")
          .style("fill", function(d,i) {
            return color(d.data[0]);
          })
          .attr("stroke", "white")
          .style("stroke-width", "2px")
          .style("opacity", 1)

          .on('mouseenter', function (actual, i) {

            Tooltip
              .style("opacity", 1)
            d3.select(this)
              .style("stroke", "black")
              .style("stroke-width", "4px")
              .style("opacity", 1)
            
          })

          .on('mousemove', function(mouse, d) {
            Tooltip
            .html(d.data[0] == "M" ? "Género: Masculino" + "<br>Valor: " + d.value : "Género: Feminino" + "<br>Valor: " + d.value)
              .style("left", (d3.pointer(mouse)[0]+500) + "px")
              .style("top", (d3.pointer(mouse)[1]+900) + "px")
              .style("color", "black")
          })

          .on('mouseleave', function () {
              Tooltip
                .style("opacity", 0)
              d3.select(this)
                .style("stroke", "white")
                .style("stroke-width", "2px")
                .style("opacity", 1)
          })

        g.append("text")
          .attr("transform", function(d, i) {

            var _d = arc.centroid(d);
            console.log(_d)
            _d[0] = _d[0] + 350;	//multiply by a constant factor
            _d[1] = _d[1] + 200;	//multiply by a constant factor
            console.log(_d)
            return "translate(" + _d + ")";
          })
          .attr("dy", ".50em")
          .style("text-anchor", "middle")
          .text(function(d) {
            if(d.data[1].percentage < 8) {
              return '';
            }
            return d.data[1].percentage + '%';
          });


        // again rebind for legend
        var legendG = svg3.selectAll(".legend") // note appending it to mySvg and not svg to make positioning easier
          .data(pie(data_ready))
          .enter().append("g")
          .attr("transform", function(d,i){
            return "translate(" + (width - margin/2) + "," + (i * 15 + height) + ")"; // place each legend on the right and bump each one down 15 pixels
          })
          .attr("class", "legend");   

        legendG.append("rect") // make a matching color rect
          .attr("width", 10)
          .attr("height", 10)
          .attr("fill", function(d, i) {
            return color(d.data.data[0]);
          });

        legendG.append("text") // add the text
          .text(function(d){
            return d.data.data[0] == "M" ? "Masculino" : "Feminino";
          })
          .style("font-size", 12)
          .attr("y", 10)
          .attr("x", 11);


         //Título
         svg3.append('text')
              .attr('class', 'title')
              .attr('x',  width / 2 + margin)
              .attr('y', 40)
              .attr('text-anchor', 'middle')
              .text('População por Género')
          
          //Source
          svg3.append('text')
              .attr('class', 'source')
              .attr('x', width - margin / 2)
              .attr('y', 380)
              .attr('text-anchor', 'start')
              .text('Source: INE, 2020')





        function esperanca_media_vida_graph(dataset, margin, width, height) {

          // create a tooltip
          var Tooltip = d3.select("#container2")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px")


          svg2 = d3.select("#svg2")
                    .attr("width", width + margin + margin)
                    .attr("height", height + margin + margin);
          const chart = svg2.append('g').attr("transform",
                    "translate(" + margin + "," + margin + ")");

          // X axis
          var x = d3.scaleBand()
            .range([ 0, width ])
            .domain(dataset.map(function(d) { return d.year; }))
            .padding(0.5);
            
          chart.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x))
            .selectAll("text")
              .attr("opacity", function(d) { return d % 2 == 0 ? 1 : 0 })
              .attr("transform", "translate(-10,0)rotate(-45)")
              .style("text-anchor", "end");
              


          // Add Y axis
          var y = d3.scaleLinear()
            .domain([0, 100])
            .range([ height, 0]);
          chart.append("g")
            .call(d3.axisLeft(y));

          // Lines
          chart.selectAll("myline")
            .data(dataset)
            .enter()
            .append("line")
              .attr("x1", function(d) { return x(d.year); })
              .attr("x2", function(d) { return x(d.year); })
              .attr("y1", y(0))
              .attr("y2", y(0))
              .attr("stroke", "")
              .attr("opacity", function(d) { return d.year % 2 == 0 ? 1 : 0 })


          const circleGroups = chart.selectAll()
              .data(dataset)
              .enter()
              .append('g')
              
          // Circles
          circleGroups
            .append("circle")
              .attr("cx", function(d) { return x(d.year); })
              .attr("cy", y(0))
              .attr("r", "4")
              .style("fill", "#69b3a2")
              .attr("stroke", "none")


            
              .on('mouseenter', function (actual, i) {
                d3.select(this)
                    .attr('opacity', 0)
                    
                d3.select(this)
                    .transition()
                    .duration(300)
                    .attr('opacity', 1)
                
                // Show line
                line = chart.append('line')
                    .attr('id', 'limit')
                    .attr('x1', 0)
                    .attr('y1', y(i.value))
                    .attr('x2', width)
                    .attr('y2', y(i.value))
                
                Tooltip
                  .style("opacity", 1)
                d3.select(this)
                  .style("stroke", "black")
                  .style("opacity", 1)
                
              })

              .on('mousemove', function(mouse, d) {
                Tooltip
                  .html("Ano: " + d.year + "<br>Valor: " + d.value)
                    .style("left", (d3.pointer(mouse)[0]+285) + "px")
                    .style("top", (d3.pointer(mouse)[1]+410) + "px")
                    .style("color", "black")
              })
              
              // On mouse leave, remove the line and the bar value
              .on('mouseleave', function () {
                  d3.select(this)

                  svg2.selectAll('#limit').remove()
                  svg2.selectAll('.value').remove()

                  Tooltip
                    .style("opacity", 0)
                  d3.select(this)
                    .style("stroke", "none")
                    .style("opacity", 1)
              })

            
          // Change the X coordinates of line and circle
          chart.selectAll("circle")
            .transition("initialCircles")
            .duration(2000)
            .attr("cy", function(d) { return y(d.value); })


          chart.selectAll("line")
            .transition("initialLines")
            .duration(2000)
            .attr("y1", function(d) { return y(d.value); })

          //Título Y
          svg2.append('text')
              .attr('class', 'label')
              .attr('x', -(height / 2) - margin)
              .attr('y', margin / 2.4 - 15)
              .attr('transform', 'rotate(-90)')
              .attr('text-anchor', 'middle')
              .text('Esperança Média de Vida')
          
          //Título X
          svg2.append('text')
              .attr('class', 'label')
              .attr('x', width / 2 + margin)
              .attr('y', 370)
              .attr('text-anchor', 'middle')
              .text('Anos')
          
          //Título
          svg2.append('text')
              .attr('class', 'title')
              .attr('x',  width / 2 + margin)
              .attr('y', 40)
              .attr('text-anchor', 'middle')
              .text('Esperança Média de Vida')
          
          //Source
          svg2.append('text')
              .attr('class', 'source')
              .attr('x', width - margin / 2)
              .attr('y', 380)
              .attr('text-anchor', 'start')
              .text('Source: INE, 2020')

        

        }

















        function faixa_etaria_graph(dataset, margin, width, height) {
          svg = d3.select("#svg1");
          const svgContainer = d3.select('#container1');

          const chart = svg.append('g').attr('transform', `translate(${margin}, ${margin})`);

          //let labels = ["0-04", "05-09", "10-14",	"15-19", "20-24", "25-29", "30-34",	"35-39", "40-44", "45-49", "50-54",	"55-59", "60-64", "65-69", "70-74", "+75"]
          //Eixo X
          const xScale = d3.scaleBand()
          .range([0, width])
          .domain(dataset.map((s) => s.type))
          .padding(0.1)
          
          
          /*
          Determinar o maior valor para o eixo dos Y
          */
          var biggest_value=0;
          for (i in dataset){
              if (+dataset[i].value > biggest_value){
                  biggest_value = dataset[i].value;
              }
          }
          
          //Eixo Y
          const yScale = d3.scaleLinear()
          .range([height, 0])
          .domain([0, biggest_value]);
          
          const makeYLines = () => d3.axisLeft().scale(yScale)
          
          /*
          Construir o gráfico
          */
          chart.append('g')
          .attr('transform', `translate(0, ${height})`)
          .call(d3.axisBottom(xScale))
          .selectAll(".tick text")  
          .call(wrap, xScale.bandwidth());
      
          chart.append('g')
              .call(d3.axisLeft(yScale));

              chart.append('g')
              .attr('class', 'grid')
              .call(makeYLines()
                  .tickSize(-width, 0, 0)
                  .tickFormat('')
              )
      
          const barGroups = chart.selectAll()
              .data(dataset)
              .enter()
              .append('g')

          barGroups.append('rect')
              .attr('class', 'bar')
              .attr('x', (g) => xScale(g.type))
              .attr('y', (g) => yScale(g.value))
              .attr('height', (g) => height - yScale(g.value))
              .attr('width', xScale.bandwidth())
              .on('mouseenter', function (actual, i) {
                d3.select(this)
                    .attr('opacity', 0)
                    
                d3.select(this)
                    .transition()
                    .duration(300)
                    .attr('opacity', 1)
                
                const y = yScale(i.value)
                
                // Show line
                line = chart.append('line')
                    .attr('id', 'limit')
                    .attr('x1', 0)
                    .attr('y1', y)
                    .attr('x2', width)
                    .attr('y2', y)
                
                // Show bar value
                barGroups.append('text')
                    .attr('class', 'value')
                    .attr('x', (a) => xScale(a.type) )
                    .attr('y', (a) => yScale(a.value) - 3)
                    .attr('text-anchor', 'start')
                    .text((a, idx) => {
                        return a.type === i.type ? `${a.value}` : '';
                    })
              })
              
              // On mouse leave, remove the line and the bar value
              .on('mouseleave', function () {
                  d3.select(this)
                  .transition()
                  .duration(300)
                  .attr('opacity', 1)

                  chart.selectAll('#limit').remove()
                  chart.selectAll('.value').remove()
              })
            
          //Título Y
          svg.append('text')
              .attr('class', 'label')
              .attr('x', -(height / 2) - margin)
              .attr('y', margin / 2.4 - 15)
              .attr('transform', 'rotate(-90)')
              .attr('text-anchor', 'middle')
              .text('Número de pessoas')
          
          //Título X
          svg.append('text')
              .attr('class', 'label')
              .attr('x', width / 2 + margin)
              .attr('y', 360)
              .attr('text-anchor', 'middle')
              .text('Faixa etária')
          
          //Título
          svg.append('text')
              .attr('class', 'title')
              .attr('x', width / 2 + margin)
              .attr('y', 40)
              .attr('text-anchor', 'middle')
              .text('População por faixa etária')
            
          //Source
          svg.append('text')
              .attr('class', 'source')
              .attr('x', width - margin / 2)
              .attr('y', 380)
              .attr('text-anchor', 'start')
              .text('Source: INE, 2020')
        }
        

        
        
        /*
        Função para tornar o texto do eixo dos X legível (para casos em que é muito extenso)
        Source: http://bl.ocks.org/LGBY4/204b1c74962cbcb33feba263e0fb4ad2
        */
        function wrap(text, width) {
          text.each(function() {
              var text = d3.select(this),
                  words = text.text().split(/\s+/).reverse(),
                  word,
                  line = [],
                  lineNumber = 0,
                  lineHeight = 1.1, // ems
                  y = text.attr("y"),
                  dy = parseFloat(text.attr("dy")),
                  tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
              while (word = words.pop()) {
              line.push(word);
              tspan.text(line.join(" "));
              if (tspan.node().getComputedTextLength() > width) {
                  line.pop();
                  tspan.text(line.join(" "));
                  line = [word];
                  tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
              }
              }
          });
        }
    </script>
    


  </body>
</html>








